---
layout: post
title: 路由器折腾记
category: Auxiliary
tags: [路由器, PandoraBox, 计算机网络]
latest: 2014年06月19日 14:52:41
---

路由器的功能越来越丰富，可玩性越来越高，对于网络方面特别感兴趣的人，我想都会折腾路由器。

偶遇迅雷做活动，心动然后行动，买了一台如意云1 ( ***MT7620*** ) ，主要是用于中继学校的 ChinaNet 信号以及迅雷远程脱机下载。

现在对折腾过程做个简单的总结。

UBOOT 刷机
-

#### 1. 下载路由器处理器( 比如联想如意云-1 的 MT7620n )支持的固件：[PandoraBox for Lenovo RY-1](http://downloads.openwrt.org.cn/PandoraBox/Lenovo-Y1_RY-1S/firmware/stable/)

> 云 2 的某些固件也支持云 1。

#### 2. 禁用掉除连接路由器 LAN 口的网卡外的其他网卡，并将电脑与路由器 LAN 口连接。

+ ① 拔掉路由器 WAN 口网线，电脑网线连接路由器 LAN 口。

+ ② 路由器断电后，用笔或者牙签插进 **reset** 洞，捅住 **reset** 键不放，然后给路由器上电后倒数 20 秒钟松开，然后把笔拔出。

+ ③ 电脑 IP 设置为局域网的某个 IP，如：192.168.1.2。

> 不能设置为网关地址。

+ ④ 打开浏览器输入 192.168.1.1 后上传固件进行升级。

> 建议使用 IE 浏览器，升级过程一定请勿断电。

+ ⑤ 完成后，将电脑 IP 更改为自动获取，重新启用刚才禁用的网卡。

#### 其他

有些路由器集成了 RST/WPS 按钮( 如 **newifi**  )，突出设计以后只需要手指按住就行了。

> 断电后摁住 RST/WPS 按钮；上电后按住 5 秒以上再松开。


设置 PPPoE 拨号上网
-

> 为方便说明，路由器界面建议先切换为 Bootstrap 风格：系统 -> 语言和界面。

### 添加/修改新接口

找到 **网络 -> 接口 -> 添加新接口 -> 创建新接口**，填写接口名( 随意 )，选择接口采用的协议为 PPPoE，然后选择 **保持&应用**。

在接口列表中修改刚刚创建的接口，找到 **一般设置 -> 基本设置**，填写  **PAP/CHAP用户名和密码**( 即 ISP 提供的宽带账号密码 )，然后选择 **保持&应用**。

> 这里也可以不添加新接口而直接修改默认的接口。


在路由器 **备份/升级** 界面更新固件
-

没什么好说的，找到 **系统 -> 备份/升级 -> 刷写新的固件**，然后上传兼容的路由器固件更新即可。


PandoraBox 中继 ChinaNet 
-

找到 **网络 -> 无线 -> 搜索**，在搜索结果中选择你要中继的无限信号，这里即 ChinaNet。

找到信号衰减最小的信号，选择 **加入网络**

在出现的设置界面，取消勾选 **重置无线配置**，新的网络名称默认即可，然后提交。

在出现的 **接口配置-> 基本配置** 中设置 ChinaNet 的模式为 **Client**，然后 **保存&应用**。

> 这里的 Client 和 Master 是相对于路由器的概念，路由器是发射无线信号的设备，因此它称为 Master，每个路由器之外的其他路由器发射的信号都是 Client。

找到 **网络 -> 接口**，找到刚刚新添加的无线接口名，点击 **修改**。

将 **DHCP** 协议切换为 **PPPoE**，然后填写账户密码，然后 **保存&应用**。

如果不出意外，其他网卡此时便可以通过路由器中继的，已拨号成功的 ChinaNet 网络信号接入 Internet 了。

> 贵州 ChinaNet 拨号格式：`账号@cw.gz.chntel.com`；密码需要动态获取：[ChinaNet-0](http://61.139.61.216:8080/hwssp/index.do) or [ChinaNet-1](http://61.180.1.4/portal4JX/hw)。

> [贵州电信账户充值](http://pay.gz163.cn/web/index.php)

> 有时候上级路由器可能会更改信道导致中继失败，这时重复上述操作即可。

迅雷远程脱机下载
-

该步骤需要在路由器系统中下载安装一个插件：[Aria2](http://aria2.sourceforge.net/)。

> 迅雷离线公开的 API 支持 Aria2。

> 为了节省时间，也可以选择自带了 Aria2 的 PandoraBox 固件。

### PandoraBox安装 Aria2

上面的步骤完成后，便可以通过 Web 或者迅雷客户端远程查看下载情况了，确实方便。

PandoraBox 端口映射与 DDNS 设置
-

通过路由器上网的计算机获得的 IP 地址基本上都是路由器分配的内网地址，所以如果想要 Internet 上的其他计算机访问路由器网关内部计算机开放的服务或资源，必须通过路由器的转发，即通常所说的 **端口映射**。

假设内网 IP 为 192.168.1.140 的 Linux 主机上运行着 Nginx，默认监听端口为 80 端口，那么通过 PandoraBox 设置端口映射步骤很简单，或许固件版本不一样具体设置位置不同，单原理都是一样的：

1. PandoraBox Web 界面中找到 “网络” -> “防火墙” -> “端口转发”。

2. “新建端口转发” 中填写：

- 共享名：自定义。

- 协议：如果不清楚服务采用的协议，建议选择 TCP + UDP。

- 外部区域：wan。

- 外部端口：自定义，理论上是 1~65535，但是部分端口号由于运营商的原因被封，比如 80，8080，6666 等，此外部分端口已经被其他服务所监听，所以这里选择端口号需要是可用的。

- 内部区域：lan。

- 内部 IP 地址：192.168.1.140。

- 内部端口：选择内部 IP 上所要提供给 Internet 访问的服务所监听的端口，如 Nginx 的话就是 80。

3. "添加"，然后 "保存&应用" 。

### 远程管理路由器

通过端口映射，可以实现远程管理路由器。只需把上面的 “内部 IP 地址” 改为路由器在局域网中的 IP，即使路由器网关地址：192.168.1.1。

这里需要说明的是，也可以更改 PandoraBox 监听的 HTTP 端口号，找到：“系统” -> “HTTP服务” -> "监听的HTTP地址"，更改 `0.0.0.0` 和 `[::]` 后面的端口号为你想要监听的端口号，**同时，关闭 “启用 RFC1918 过滤”**。然后在上面的步骤中把 "内部端口" 改为现在这个端口即可。

现在你就可以通过路由器获得的公网 IP + 端口映射中配置过的可用端口号来访问内网中的各种服务了。如果绑定了域名，通过域名+端口也是一样的效果。

公网 IP 可以在接口总览中查看，也可以通过百度搜索 IP 等网站查看。

### **端口映射 Q&A**


- 按照上面做了仍然不成功？

1、 计算机上的防火墙没有放行。

2、 一般只有 Service 进程才可以被外网访问，如果是控制台程序进程监听该端口，则即使端口映射成功也不能访问到服务。一句话，只有具有 “服务” 性质的进程被映射后被 Internet 访问。Windows 中可以通过如下命令查看进程号和其所占用的端口:

```
netstat -ano | findstr "port"
tasklist | findsrt "pid"
```

3、 有可能 ISP 给你的也不是公网 IP，相当于你路由器获得的 IP 仍然是内网 IP，需要在获得公网 IP 的上级路由器中再次进行端口映射。

- 为什么 Nginx 作为控制台进程通过端口映射却能被外网访问？

1、 也许是因为测试的端口都被封掉了。

2、 也许是因为 Nginx 生来就带有服务器的性质。

- 为什么在路由器上做映射后内网 IP 反而无法访问相关服务了？

建议内网计算机按静态 IP 分配。

#### 关于 **IP 回流**

关于端口转发后公网可以访问内网服务而内网 IP 无法通过公网 IP （或域名）访问内网服务的问题解决思路：
	
公网 IP 使用域名访问内网服务，而内网 IP 直接通过内网 IP 访问，或者在内网网关中配置 DNS，使本指向公网 IP 的域名在内网中直接指向提某个服务的内网 IP。

### PandoraBox 配置 DDNS

完成了上面的端口映射后，Internet 上的计算机是可以通过 `IP:PORT` 的方式在浏览器上 **暂时** 访问我们内网中计算机的服务和资源了，为什么说是暂时的呢，因为一般 ISP 分配给我们的 IP 都是从 DHCP 服务器上随机分配的，也就是说，不是固定的。

那么问题就来了，既然不是固定的，别人怎么才知道某个时刻我们的公网 IP 到底是多少呢。答案是通过域名服务。

域名服务 DNS 帮我们省略了记住对人类不友好的数字 IP 地址，我们可以直接通过一个好记的名字访问到某个 IP 上的服务。

类推一下， 动态域名服务 DDNS 帮我解决的问题是保持我们的动态 IP 与静态域名随时映射的关系，这样访问我们网站的 IP 就可以不用考虑我们的服务器上的 IP 到底是静态的还是动态的了，因为我们不通过 IP ( 虽然可以直接通过 IP ) 来访问网站。

假设 DDNS 提供方是花生壳，那么 PandoraBox 设置 Oray DDNS 的方法如下：

找到 “服务” -> “动态DNS” -> “启用”，然后下面的内容填写如下：

- 使用网络接口：选择获得公网 IP 的那个接口。

- 服务提供商：PandoraBox 中没有内置花生壳动态域名服务，所以选择自定义。

- 更新的 URL：这里选择在花生壳官网上注册的二级域名。

- 主机名：固定写 `ddns.oray.com`。

- 用户名和密码；是你在花生壳网站上注册的用户名和密码。

- IP 来源：URL。

- URL：固定写 `/ph/update?`。

- 检查IP变动的时间间隔和强制更新间隔：根据需要配置即可。

然后 “保存&应用”。我的配置如下：

![PandoraBox 中配置花生壳 DDNS]()

##### **说明**

如果是内网 IP 开放的待访问服务器使用花生壳 DDNS 服务，则必须要下载花生壳内网版并登录，这样的目的是保证你的二级域名一直在线，并接受 DDNS 更新。

文件共享
-

将一些常用的东西放在路由器上面，让局域网中的所有 IP 访问。

在路由器上安装服务器
-



##### 关于路由器的其他玩法：未完待续... ...

参考
-

- [Current IP Check](http://checkip.dyndns.com/)

- [浅谈内网web服务器发布到公网后路由器回流问题--NAT--PAT---技术研究](http://zhan.renren.com/cqhqhsj?gid=3602888498000970436&checked=true)

- [如何在ddwrt内核路由器中设置花生壳ddns（公网版）](http://service.oray.com/question/868.html)

- [PandoraBox 固件下载](http://downloads.openwrt.org.cn/PandoraBox/)

- [使用PandoraBox固件的迅雷远程下载](http://www.right.com.cn/Forum/thread-162040-1-1.html)

- [在路由器上写CMCC自动登录验证脚本 | Xiaoxia[PG]](http://xiaoxia.org/2012/04/28/mini-router-auto-login-cmcc/)
